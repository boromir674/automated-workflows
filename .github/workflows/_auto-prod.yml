#####################################
## Auto Merge PR to Main  - GitOps ##
#####################################

# Part of 'release-me' Git Ops Process: User Br -> release -> main

# Triggers on pushed auto-prod-* tags

# EG
# export tt='auto-prod-1.3.0'
# OR
# export tt='auto-prod-1.2.1-dev'
# git tag -d "$tt"; git push --delete origin "$tt"; git tag "$tt" && git push origin "$tt"

#### Does the following:
#  1. Derives a Git Tag to make an RC Tag
#  2. Tags commit on release branch with RC Tag
####


on:
  push:
    tags:
      - auto-prod-*
# jobs:
#   # please add 'main' Rule Required Checks, before running this job
#   auto_merge_pr_to_main:
#     uses: boromir674/automated-workflows/.github/workflows/go-auto-merge-main.yml@test
#     with:
#       main_branch: ${{ vars.GIT_MAIN_BRANCH || 'main' }}
#       release_branch: ${{ vars.GIT_RELEASE_BRANCH || 'release' }}
#       commit_message: 'Automated Workflows'
#     secrets:
#       pat_token: ${{ secrets.GA_WORKFLOWS_CI_PR_RW_AND_ACTIONS_RW }}

jobs:
  merge_release_into_main:
    runs-on: ubuntu-latest
    env:
      GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
      RELEASE_BR: 'release'
      MAIN_BR: ${{ vars.GIT_MAIN_BRANCH || 'main' }}
      COMMIT_MSG_ON_RELEASE_BR: 'Automated Workflows'
    steps:
      - uses: actions/checkout@v4
        with:
          fetch-depth: 0  # 0 indicates all history for all branches and tags.
          set-safe-directory: ''  # `git config --global --add safe.directory <path>`
          token: '${{ secrets.GA_WORKFLOWS_CI_PR_RW_AND_ACTIONS_RW }}'

      - run: git branch --track "${{ env.RELEASE_BR }}" "origin/${{ env.RELEASE_BR }}" 

      - name: "Check if tag is on '${{ env.RELEASE_BR }}' branch"
        uses: rickstaa/action-contains-tag@v1
        id: tag_on_release
        with:
          tag: "${{ github.ref }}"
          reference: "${{ env.RELEASE_BR }}"  # the branch to check if the tag is on

      # REQUIRE Tag to be on Release Branch, else Exit with Error
      - if: ${{ steps.tag_on_release.outputs.retval == 'false' }}
        name: "Exit if '${{ github.ref }}' NOT on '${{ env.RELEASE_BR }}' branch"
        run: echo "Tag '${{ github.ref }}' on '${{ env.RELEASE_BR }}' = ${{ steps.tag_on_release.outputs.retval }}" && exit 1

      # READ NEW SEM VER from pushed git tag, ie '1.2.0' from 'auto-prod-1.2.0'
      - name: Read New Sem Ver from Tag
        id: sem_ver
        run: |
          NEW_SEMVER=$(echo "${{ github.ref }}" | cut -d'-' -f3)
          echo "[INFO]: New Sem Ver: $NEW_SEMVER"
          echo "**New Sem Ver: $NEW_SEMVER**" >> $GITHUB_STEP_SUMMARY
          echo SEMVER=$NEW_SEMVER >> $GITHUB_OUTPUT

      # Find if it is a PROD (Public API) or DEV (ie internal changes, only docs, etc)
      - name: "Check if it is a PROD or DEV Release"
        id: prod_or_dev
        run: |
          if [[ "${{ steps.sem_ver.outputs.SEMVER }}" == *dev* ]]; then
            echo "PROD_OR_DEV=DEV" >> $GITHUB_OUTPUT
          else
            echo "PROD_OR_DEV=PROD" >> $GITHUB_OUTPUT
          fi

      # ie 1.0.1-> v1.0.1-rc
      - name: 'Derive RC Git Tag from PROD Release: prepend v and append -rc to Sem Ver'
        if: ${{ steps.prod_or_dev.outputs.PROD_OR_DEV == 'PROD' }}
        run: 'echo RC_TAG="v${{ steps.sem_ver.outputs.SEMVER }}-rc" >> $GITHUB_ENV'

      # ie 1.0.1-dev-> v1.0.1-rc
      - name: 'Derive RC Git Tag from DEV Release: prepend v, use <M.m.p> part from Sem Ver and append -rc'
        if: ${{ steps.prod_or_dev.outputs.PROD_OR_DEV == 'DEV' }}
        # run: 'echo RC_TAG="v${{ steps.sem_ver.outputs.SEMVER }}" >> $GITHUB_ENV'
        run: 'echo RC_TAG="v$(echo ${{ steps.sem_ver.outputs.SEMVER }} | grep -oP "^\d+\.\d+\.\d+")-rc" >> $GITHUB_ENV'

      # potentially trigger Deployment into Staging/Test
      - name: "Create and Push RC Tag ${{ env.RC_TAG }}"
        run: |
          git tag -d "$RC_TAG" || true
          git tag "$RC_TAG"
          git push --delete origin "$RC_TAG" || true
          git push origin "$RC_TAG"

          echo "Tag ${{ env.RC_TAG }} was **pushed to remote**" >> $GITHUB_STEP_SUMMARY
          echo " -> Pushed tag $RC_TAG"

      # Derive Commit subject for PR Merge, based on PROD or DEV
      - name: 'Create Commit Message: [NEW] ${{ env.COMMIT_MSG_ON_RELEASE_BR }} v${{ steps.sem_ver.outputs.SEMVER }} Release'
        if: ${{ steps.prod_or_dev.outputs.PROD_OR_DEV == 'PROD' }}
        run: 'echo CM_MSG="[NEW] ${{ env.COMMIT_MSG_ON_RELEASE_BR }} v${{ steps.sem_ver.outputs.SEMVER }} Release" >> $GITHUB_ENV'

      - name: 'Create Commit Message: [DEV] ${{ env.COMMIT_MSG_ON_RELEASE_BR }} v${{ steps.sem_ver.outputs.SEMVER }} Release'
        if: ${{ steps.prod_or_dev.outputs.PROD_OR_DEV == 'DEV' }}
        run: 'echo CM_MSG="[DEV] ${{ env.COMMIT_MSG_ON_RELEASE_BR }} v${{ steps.sem_ver.outputs.SEMVER }} Release" >> $GITHUB_ENV'

      # LABEL PR for Auto Deploy, to trigger 'Tag Prod' Workflow after merge
      - name: "Label PR for Auto Deploy"
        run: gh pr edit "${{ env.RELEASE_BR }}" --add-label "auto-deploy"

      ### Merge PR, when CI Pass + Human Review OK ###
      - name: "Merge PR   'head': ${{ env.RELEASE_BR }}  -->  'base': ${{ env.MAIN_BR }}"
        run: gh pr merge "${{ env.RELEASE_BR }}" --auto --delete-branch --merge --subject "${{ env.CM_MSG }}"
        env:
          GH_TOKEN: ${{ secrets.GA_WORKFLOWS_CI_PR_RW_AND_ACTIONS_RW }}
